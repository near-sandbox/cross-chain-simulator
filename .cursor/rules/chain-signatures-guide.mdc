---
alwaysApply: true
description: Chain Signatures Simulator (Layer 3) - MPC infrastructure + Chain Signatures API
---

# Chain Signatures Simulator Guide

**Layer 3: Cross-chain signing primitives with embedded MPC infrastructure**

## Layer Architecture Position

**This is Layer 3 of the 5-layer NEAR Localnet Simulator Stack:**

```
Layer 1: NEAR Base          → AWSNodeRunner
Layer 2: NEAR Services      → near-localnet-services
Layer 3: Chain Signatures   → This repository ← YOU ARE HERE (includes MPC)
Layer 4: Intents Protocol   → near-intents-simulator
Layer 5: User Applications  → Your dApp
```

**Depends on**: Layer 2 (NEAR Services)
**Provides to**: Layer 4 (Intents Protocol) - Chain Signatures API for cross-chain operations

**Architecture Reference**: See `/CORRECTED_ARCHITECTURE.md` for complete stack details.

## Critical: MPC is Embedded in This Layer

**Important architectural fact**: MPC infrastructure is **NOT a separate layer**. It's embedded within this repository:

```
cross-chain-simulator/                    # Layer 3 package
├── src/chain-signatures/                 # Chain Signatures API
│   ├── mpc-service.ts                    # Uses MPC nodes
│   └── near-client.ts                    # v1.signer contract calls
└── cross-chain-simulator/mpc-repo/       # Embedded MPC infrastructure
    └── infra/aws-cdk/                    # AWS CDK for MPC nodes
        ├── lib/mpc-network.ts            # MPC node deployment
        ├── scripts/                      # Key generation, secrets
        └── QUICKSTART.md                 # MPC deployment guide
```

When deploying this layer, you deploy:
1. MPC infrastructure (3-8 nodes)
2. v1.signer contract
3. Chain Signatures API

All three components work together as a single unit (Layer 3).

## What This Layer Provides

### Chain Signatures API
- Address derivation for BTC, ETH, DOGE, etc.
- Transaction signing via MPC threshold signatures
- v1.signer contract interaction
- Production-equivalent API matching mainnet

### MPC Infrastructure (Embedded)
- 3-8 MPC nodes from github.com/near/mpc
- Threshold signature generation (cait-sith)
- AWS CDK deployment infrastructure
- Key management and rotation

## Usage

```typescript
import { 
  createChainSignaturesClient,
  LocalnetConfig,
  getNearRpcUrl,
  getMpcContractId,
  getMpcNodes
} from '@near-sandbox/cross-chain-simulator';

// Use default localnet config
const client = createChainSignaturesClient();

// Or provide custom config
const config: LocalnetConfig = {
  rpcUrl: getNearRpcUrl(),
  mpcContractId: getMpcContractId(),
  mpcNodes: getMpcNodes(),
  networkId: 'localnet'
};
const client = createChainSignaturesClient(config);

// Derive address via real MPC
const btcAddr = await client.deriveAddress('user.near', 'bitcoin');

// Sign transaction via real MPC
const sig = await client.requestSignature({
  nearAccount: 'user.near',
  chain: 'ethereum',
  payload: '0x...'
});
```

## Deployment

### Start Complete Infrastructure
```bash
npm run start:localnet
```

This starts:
- MPC nodes (3-8 nodes)
- Deploys v1.signer contract
- Initializes Chain Signatures

### Stop Infrastructure
```bash
npm run stop:localnet
```

### MPC Only
```bash
npm run start:mpc  # Start MPC nodes
npm run stop:mpc   # Stop MPC nodes
```

## Configuration

### From Environment
```bash
export NEAR_RPC_URL=http://10.0.55.70:3030
export MPC_NODE_COUNT=3
export MPC_CONTRACT_ID=v1.signer.node0
```

### From Code
```typescript
const config: LocalnetConfig = {
  rpcUrl: process.env.NEAR_RPC_URL || 'http://localhost:3030',
  mpcContractId: process.env.MPC_CONTRACT_ID || 'v1.signer.node0',
  mpcNodes: [
    'http://localhost:3000',
    'http://localhost:3001',
    'http://localhost:3002'
  ],
  networkId: 'localnet'
};
```

## Orchestrator Integration

When deployed via near-localnet-orchestrator, this layer:
1. Receives NEAR RPC URL from Layer 1
2. Receives faucet endpoint from Layer 2
3. Deploys MPC infrastructure
4. Deploys v1.signer contract
5. Exports chain_signatures_config to Layer 4

## Important Notes

1. **This is a complete layer**: Includes both MPC and Chain Signatures
2. **MPC is not separate**: Don't treat MPC as Layer 2 or any other layer
3. **Depends on NEAR Services**: Layer 2 provides utilities needed for setup
4. **Used by Intents**: Layer 4 consumes the Chain Signatures API
5. **Real infrastructure**: This is not a mock - it runs real MPC nodes

## Repository Structure

```
cross-chain-simulator/
├── src/
│   ├── chain-signatures/        # Chain Signatures API implementation
│   ├── localnet/                # Localnet orchestration
│   └── config.ts                # Configuration exports
├── cross-chain-simulator/       # Embedded MPC repo
│   └── mpc-repo/
│       └── infra/aws-cdk/       # AWS CDK for MPC deployment
├── README.md                    # "Layer 3: Chain Signatures"
└── ARCHITECTURE.md              # Detailed architecture
```

## AWS Profile

All AWS commands use: `--profile shai-sandbox-profile`
